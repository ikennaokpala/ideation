{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://sparc-dsl.dev/schemas/data.yaml.json",
  "title": "SPARC Data DSL Schema",
  "description": "Schema for `dsl/data.yaml` files (database entities, enums, relationships, seeds).",
  "type": "object",
  "additionalProperties": true,
  "required": ["$schema", "version", "meta", "entities"],
  "properties": {
    "$schema": { "type": "string" },
    "version": { "type": "string", "pattern": "^\\d+\\.\\d+(\\.\\d+)?$" },
    "meta": { "$ref": "#/definitions/meta" },
    "enums": { "type": "array", "items": { "$ref": "#/definitions/enum_def" } },
    "entities": { "type": "array", "items": { "$ref": "#/definitions/entity_def" }, "minItems": 1 },
    "relationships": { "type": "array", "items": { "$ref": "#/definitions/relationship_def" } },
    "views": { "type": "array" },
    "functions": { "type": "array" },
    "seeds": { "type": "array" },
    "migrations": { "type": "array" },
    "simulation": { "type": "object" }
  },
  "definitions": {
    "meta": {
      "type": "object",
      "additionalProperties": true,
      "required": ["name", "version"],
      "properties": {
        "name": { "type": "string" },
        "description": { "type": "string" },
        "version": { "type": "string" },
        "database": { "type": "object" },
        "orm": { "type": "object" },
        "conventions": { "type": "object" }
      }
    },
    "enum_value": {
      "type": "object",
      "additionalProperties": true,
      "required": ["value"],
      "properties": {
        "value": {},
        "description": { "type": "string" }
      }
    },
    "enum_def": {
      "type": "object",
      "additionalProperties": true,
      "required": ["name", "values"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "values": { "type": "array", "items": { "$ref": "#/definitions/enum_value" }, "minItems": 1 }
      }
    },
    "validator_def": {
      "type": "object",
      "additionalProperties": true,
      "required": ["type"],
      "properties": {
        "type": { "type": "string" },
        "value": {},
        "message": { "type": "string" }
      }
    },
    "field_def": {
      "type": "object",
      "additionalProperties": true,
      "required": ["name", "type"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "type": { "type": "string", "minLength": 1 },
        "length": { "type": "integer", "minimum": 1 },
        "nullable": { "type": "boolean" },
        "unique": { "type": "boolean" },
        "primary_key": { "type": "boolean" },
        "default": {},
        "enum_ref": { "type": "string" },
        "references": { "type": "string" },
        "on_delete": { "type": "string" },
        "sensitive": { "type": "boolean" },
        "validators": { "type": "array", "items": { "$ref": "#/definitions/validator_def" } }
      }
    },
    "index_def": {
      "type": "object",
      "additionalProperties": true,
      "required": ["columns"],
      "properties": {
        "name": { "type": "string" },
        "columns": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
        "unique": { "type": "boolean" }
      }
    },
    "constraint_def": {
      "type": "object",
      "additionalProperties": true,
      "required": ["type"],
      "properties": {
        "type": { "type": "string" },
        "name": { "type": "string" },
        "expression": { "type": "string" }
      }
    },
    "trigger_def": {
      "type": "object",
      "additionalProperties": true,
      "required": ["name"],
      "properties": {
        "name": { "type": "string" },
        "timing": { "type": "string" },
        "event": { "type": "string" },
        "action": { "type": "string" }
      }
    },
    "rls_def": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "enabled": { "type": "boolean" },
        "policies": { "type": "array" }
      }
    },
    "entity_def": {
      "type": "object",
      "additionalProperties": true,
      "required": ["name", "fields"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "table_name": { "type": "string" },
        "fields": { "type": "array", "items": { "$ref": "#/definitions/field_def" }, "minItems": 1 },
        "indexes": { "type": "array", "items": { "$ref": "#/definitions/index_def" } },
        "constraints": { "type": "array", "items": { "$ref": "#/definitions/constraint_def" } },
        "triggers": { "type": "array", "items": { "$ref": "#/definitions/trigger_def" } },
        "rls": { "$ref": "#/definitions/rls_def" }
      }
    },
    "relationship_side": {
      "type": "object",
      "additionalProperties": false,
      "required": ["entity", "field"],
      "properties": {
        "entity": { "type": "string", "minLength": 1 },
        "field": { "type": "string", "minLength": 1 }
      }
    },
    "relationship_def": {
      "type": "object",
      "additionalProperties": true,
      "required": ["name", "type", "from", "to"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "type": { "type": "string" },
        "from": { "$ref": "#/definitions/relationship_side" },
        "to": { "$ref": "#/definitions/relationship_side" },
        "on_delete": { "type": "string" }
      }
    }
  }
}

