{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://sparc-dsl.dev/schemas/api.yaml.json",
  "title": "SPARC API DSL Schema",
  "description": "Schema for `dsl/api.yaml` files (REST/OpenAPI oriented).",
  "type": "object",
  "additionalProperties": true,
  "required": ["$schema", "version", "meta", "endpoints"],
  "properties": {
    "$schema": { "type": "string" },
    "version": { "type": "string", "pattern": "^\\d+\\.\\d+(\\.\\d+)?$" },
    "meta": { "$ref": "#/definitions/meta" },
    "openapi": { "type": "object" },
    "security": { "type": "object" },
    "schemas": { "type": "array", "items": { "$ref": "#/definitions/named_schema" } },
    "endpoints": { "type": "array", "items": { "$ref": "#/definitions/endpoint" }, "minItems": 1 },
    "webhooks": { "type": "object" },
    "simulation": { "type": "object" }
  },
  "definitions": {
    "meta": {
      "type": "object",
      "additionalProperties": true,
      "required": ["name", "version"],
      "properties": {
        "name": { "type": "string" },
        "description": { "type": "string" },
        "version": { "type": "string" },
        "api": {
          "type": "object",
          "additionalProperties": true,
          "properties": {
            "type": { "enum": ["rest", "graphql", "grpc"] },
            "version": { "type": "string" },
            "base_path": { "type": "string" }
          }
        },
        "targets": { "type": "object" },
        "conventions": { "type": "object" }
      }
    },
    "named_schema": {
      "type": "object",
      "additionalProperties": true,
      "required": ["name", "schema"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "entity_ref": { "type": "string" },
        "schema": { "type": "object" }
      }
    },
    "rate_limit": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "requests": { "type": "integer", "minimum": 1 },
        "window": { "type": "string" },
        "by": { "type": "string" }
      }
    },
    "parameter": {
      "type": "object",
      "additionalProperties": true,
      "required": ["name", "type"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "type": { "type": "string", "minLength": 1 },
        "format": { "type": "string" },
        "required": { "type": "boolean" },
        "description": { "type": "string" },
        "enum": { "type": "array", "items": {} },
        "default": {}
      }
    },
    "request_spec": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "content_type": { "type": "string" },
        "validation_ref": { "type": "string" },
        "body": { "type": "object" },
        "query": { "type": "array", "items": { "$ref": "#/definitions/parameter" } },
        "path": { "type": "array", "items": { "$ref": "#/definitions/parameter" } },
        "headers": { "type": "array", "items": { "$ref": "#/definitions/parameter" } }
      }
    },
    "response_spec": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "description": { "type": "string" },
        "headers": { "type": "object" },
        "body": {},
        "example": {},
        "examples": { "type": "array" }
      }
    },
    "handler_spec": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "workflow_ref": { "type": "string" },
        "state_machine_ref": { "type": "string" },
        "type": { "type": "string" },
        "query": { "type": "object" },
        "event": { "type": "string" },
        "guard": { "type": "string" }
      }
    },
    "endpoint": {
      "type": "object",
      "additionalProperties": true,
      "required": ["path", "method", "responses"],
      "properties": {
        "id": { "type": "string" },
        "path": { "type": "string", "minLength": 1 },
        "method": {
          "type": "string",
          "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS", "HEAD"]
        },
        "tag": { "type": "string" },
        "summary": { "type": "string" },
        "description": { "type": "string" },
        "security": { "type": "array" },
        "rate_limit": { "$ref": "#/definitions/rate_limit" },
        "request": { "$ref": "#/definitions/request_spec" },
        "responses": {
          "type": "object",
          "additionalProperties": false,
          "patternProperties": {
            "^[1-5][0-9][0-9]$": { "$ref": "#/definitions/response_spec" }
          }
        },
        "handler": { "$ref": "#/definitions/handler_spec" }
      }
    }
  }
}

