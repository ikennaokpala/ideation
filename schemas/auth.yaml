# AUTH DSL SCHEMA - PASSWORDLESS AUTHENTICATION
# This is the canonical auth specification. See auth-passwordless-addendum.yaml for
# extended configurations and white-label tenant customization.
#
# SPARC v6.1.1
# Authentication via OTP (Email/SMS) + Social Login ONLY
# NO PASSWORDS - by design for improved security and UX

$schema: "./json-schemas/auth.schema.json"
version: "1.1"
extends: null  # This is the base auth schema

# ═══════════════════════════════════════════════════════════════════════════════
# SCHEMA METADATA
# ═══════════════════════════════════════════════════════════════════════════════

_meta:
  description: |
    Passwordless authentication specification for SPARC v6.1 projects.

    Design Rationale:
    - Passwords are the #1 attack vector (credential stuffing, breaches, phishing)
    - OTP + Social eliminates password management burden
    - Better UX: no forgotten passwords, no reset flows
    - Simpler database: no password_hash column

  related_files:
    - file: "auth-passwordless-addendum.yaml"
      purpose: "Extended white-label and multi-tenant configuration"
    - file: "platform-architecture.yaml#/unified_auth"
      purpose: "Platform-level auth architecture (if platform type)"

  code_generation:
    targets:
      - language: "typescript"
        output: "src/auth/"
        files:
          - "middleware/jwt-validator.ts"
          - "services/otp-service.ts"
          - "services/oauth-service.ts"
          - "routes/auth-routes.ts"
      - language: "rust"
        output: "src/auth/"
        files:
          - "middleware/jwt.rs"
          - "services/otp.rs"
          - "services/oauth.rs"
          - "routes/mod.rs"

# ═══════════════════════════════════════════════════════════════════════════════
# AUTHENTICATION METHODS
# ═══════════════════════════════════════════════════════════════════════════════

authentication:

  # CRITICAL: Passwordless only - this is enforced
  passwordless_only: true

  methods:

    # ─────────────────────────────────────────────────────────────────────────
    # OTP VIA EMAIL
    # Provider: MailChannels
    # ─────────────────────────────────────────────────────────────────────────

    email_otp:
      enabled: true
      primary: true

      config:
        code_length: 6
        code_type: "numeric"
        ttl_seconds: 600              # 10 minutes
        max_attempts: 3
        lockout_seconds: 900          # 15 minutes

      rate_limits:
        per_identifier:
          max_requests: 5
          window_seconds: 900
        per_ip:
          max_requests: 10
          window_seconds: 900

      delivery:
        provider: "mailchannels"

        config:
          api_endpoint: "https://api.mailchannels.net/tx/v1/send"
          api_key: "{{MAILCHANNELS_API_KEY}}"
          from_email: "{{FROM_EMAIL}}"
          from_name: "{{app_name}}"

          # Optional: Domain lockdown for Cloudflare Workers
          dkim:
            domain: "{{MAIL_DOMAIN}}"
            selector: "mailchannels"
            private_key: "{{DKIM_PRIVATE_KEY}}"

        template:
          subject: "Your {{app_name}} verification code"
          body_text: |
            Your verification code is: {{code}}

            This code expires in 10 minutes.

            If you didn't request this, ignore this email.
          body_html: |
            <!DOCTYPE html>
            <html>
            <body style="font-family: sans-serif; padding: 20px;">
              <h2>Your verification code</h2>
              <p style="font-size: 32px; font-weight: bold; letter-spacing: 8px;">{{code}}</p>
              <p>This code expires in 10 minutes.</p>
              <p style="color: #666;">If you didn't request this, ignore this email.</p>
            </body>
            </html>

    # ─────────────────────────────────────────────────────────────────────────
    # OTP VIA SMS
    # Provider: Twilio
    # ─────────────────────────────────────────────────────────────────────────

    sms_otp:
      enabled: true

      config:
        code_length: 6
        code_type: "numeric"
        ttl_seconds: 300              # 5 minutes (shorter for SMS)
        max_attempts: 3
        lockout_seconds: 900

      rate_limits:
        per_identifier:
          max_requests: 3
          window_seconds: 900
        per_ip:
          max_requests: 5
          window_seconds: 900

      delivery:
        provider: "twilio"

        config:
          account_sid: "{{TWILIO_ACCOUNT_SID}}"
          auth_token: "{{TWILIO_AUTH_TOKEN}}"
          from_number: "{{TWILIO_FROM_NUMBER}}"

          # Optional: Twilio Verify Service (recommended for better deliverability)
          verify_service_sid: "{{TWILIO_VERIFY_SERVICE_SID}}"
          use_verify_api: true

        template:
          body: "{{app_name}} code: {{code}}. Expires in 5 min."

    # ─────────────────────────────────────────────────────────────────────────
    # SOCIAL LOGIN (OAuth 2.0)
    # ─────────────────────────────────────────────────────────────────────────

    social:
      enabled: true

      providers:

        google:
          enabled: true
          client_id: "{{GOOGLE_CLIENT_ID}}"
          client_secret: "{{GOOGLE_CLIENT_SECRET}}"
          scopes: ["openid", "email", "profile"]

        apple:
          enabled: true
          client_id: "{{APPLE_CLIENT_ID}}"
          team_id: "{{APPLE_TEAM_ID}}"
          key_id: "{{APPLE_KEY_ID}}"
          private_key: "{{APPLE_PRIVATE_KEY}}"
          scopes: ["name", "email"]

        github:
          enabled: true
          client_id: "{{GITHUB_CLIENT_ID}}"
          client_secret: "{{GITHUB_CLIENT_SECRET}}"
          scopes: ["read:user", "user:email"]

        microsoft:
          enabled: true
          client_id: "{{MICROSOFT_CLIENT_ID}}"
          client_secret: "{{MICROSOFT_CLIENT_SECRET}}"
          tenant: "common"
          scopes: ["openid", "email", "profile"]

      security:
        state_ttl_seconds: 600
        pkce_enabled: true
        pkce_method: "S256"

# ═══════════════════════════════════════════════════════════════════════════════
# TOKEN CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════

tokens:

  jwt:
    algorithm: "RS256"
    issuer: "{{auth_service_url}}"
    audience: "{{platform_name}}"

    keys:
      private_key_path: "{{JWT_PRIVATE_KEY_PATH}}"
      public_key_path: "{{JWT_PUBLIC_KEY_PATH}}"
      # Or use environment variables
      private_key_env: "JWT_PRIVATE_KEY"
      public_key_env: "JWT_PUBLIC_KEY"

  access_token:
    ttl_seconds: 900                  # 15 minutes

    claims:
      standard:
        - sub                         # User ID
        - iat                         # Issued at
        - exp                         # Expiration
        - iss                         # Issuer
        - aud                         # Audience
      custom:
        - org_id                      # Organization ID
        - org_slug                    # Organization slug
        - role                        # Role in org
        - permissions                 # Permission array
        - auth_method                 # How user authenticated

  refresh_token:
    ttl_seconds: 604800               # 7 days
    rotation: true
    storage: "database"               # database | redis

# ═══════════════════════════════════════════════════════════════════════════════
# SESSION MANAGEMENT
# ═══════════════════════════════════════════════════════════════════════════════

sessions:

  store: "redis"
  prefix: "session:"

  config:
    ttl_seconds: 2592000              # 30 days
    sliding_window: true

  data:
    - user_id
    - organization_id
    - auth_method
    - ip_address
    - user_agent
    - created_at
    - last_activity_at

  concurrent_sessions: "unlimited"    # or number

# ═══════════════════════════════════════════════════════════════════════════════
# DATABASE SCHEMA
# ═══════════════════════════════════════════════════════════════════════════════

database:

  tables:

    users:
      columns:
        - name: id
          type: uuid
          primary: true
          default: "gen_random_uuid()"

        - name: email
          type: varchar(255)
          unique: true
          nullable: false

        - name: email_verified
          type: boolean
          default: false

        - name: phone
          type: varchar(20)
          unique: true
          nullable: true

        - name: phone_verified
          type: boolean
          default: false

        - name: name
          type: varchar(255)
          nullable: true

        - name: avatar_url
          type: text
          nullable: true

        - name: preferred_auth_method
          type: varchar(20)
          default: "'email_otp'"
          check: "preferred_auth_method IN ('email_otp', 'sms_otp', 'social')"

        - name: last_login_at
          type: timestamptz
          nullable: true

        - name: created_at
          type: timestamptz
          default: "NOW()"

        - name: updated_at
          type: timestamptz
          default: "NOW()"

      # NO password_hash column! This is intentional.

      indexes:
        - columns: [email]
          unique: true
        - columns: [phone]
          unique: true
          where: "phone IS NOT NULL"

    oauth_connections:
      columns:
        - name: id
          type: uuid
          primary: true
          default: "gen_random_uuid()"

        - name: user_id
          type: uuid
          references: users(id)
          on_delete: cascade

        - name: provider
          type: varchar(20)
          nullable: false

        - name: provider_user_id
          type: varchar(255)
          nullable: false

        - name: email
          type: varchar(255)
          nullable: true

        - name: access_token_encrypted
          type: text
          nullable: true

        - name: refresh_token_encrypted
          type: text
          nullable: true

        - name: token_expires_at
          type: timestamptz
          nullable: true

        - name: raw_profile
          type: jsonb
          nullable: true

        - name: created_at
          type: timestamptz
          default: "NOW()"

        - name: updated_at
          type: timestamptz
          default: "NOW()"

      indexes:
        - columns: [provider, provider_user_id]
          unique: true
        - columns: [user_id, provider]
          unique: true
        - columns: [user_id]

    otp_requests:
      columns:
        - name: id
          type: uuid
          primary: true
          default: "gen_random_uuid()"

        - name: identifier
          type: varchar(255)
          nullable: false
          comment: "Email or phone number"

        - name: identifier_type
          type: varchar(10)
          nullable: false
          check: "identifier_type IN ('email', 'phone')"

        - name: code_hash
          type: varchar(255)
          nullable: false

        - name: purpose
          type: varchar(20)
          nullable: false
          check: "purpose IN ('login', 'signup', 'verify_email', 'verify_phone', 'link_account')"

        - name: attempts
          type: integer
          default: 0

        - name: max_attempts
          type: integer
          default: 3

        - name: expires_at
          type: timestamptz
          nullable: false

        - name: verified_at
          type: timestamptz
          nullable: true

        - name: ip_address
          type: inet
          nullable: true

        - name: created_at
          type: timestamptz
          default: "NOW()"

      indexes:
        - columns: [identifier, purpose]
          where: "verified_at IS NULL AND expires_at > NOW()"
        - columns: [expires_at]
          comment: "For cleanup job"

    refresh_tokens:
      columns:
        - name: id
          type: uuid
          primary: true
          default: "gen_random_uuid()"

        - name: user_id
          type: uuid
          references: users(id)
          on_delete: cascade

        - name: token_hash
          type: varchar(255)
          nullable: false
          unique: true

        - name: expires_at
          type: timestamptz
          nullable: false

        - name: revoked_at
          type: timestamptz
          nullable: true

        - name: replaced_by
          type: uuid
          nullable: true
          comment: "For token rotation tracking"

        - name: ip_address
          type: inet
          nullable: true

        - name: user_agent
          type: text
          nullable: true

        - name: created_at
          type: timestamptz
          default: "NOW()"

      indexes:
        - columns: [token_hash]
          unique: true
        - columns: [user_id]
        - columns: [expires_at]

# ═══════════════════════════════════════════════════════════════════════════════
# API ROUTES
# ═══════════════════════════════════════════════════════════════════════════════

routes:

  prefix: "/api/v1/auth"

  endpoints:

    # OTP
    - path: "/otp/request"
      method: POST
      handler: "otp.request"
      auth: false
      rate_limit: "otp_request"

    - path: "/otp/verify"
      method: POST
      handler: "otp.verify"
      auth: false
      rate_limit: "otp_verify"

    # OAuth
    - path: "/oauth/:provider"
      method: GET
      handler: "oauth.initiate"
      auth: false

    - path: "/oauth/:provider/callback"
      method: GET
      handler: "oauth.callback"
      auth: false

    - path: "/oauth/:provider/link"
      method: GET
      handler: "oauth.link"
      auth: true

    # Tokens
    - path: "/refresh"
      method: POST
      handler: "tokens.refresh"
      auth: false

    - path: "/logout"
      method: POST
      handler: "sessions.logout"
      auth: true

    # User
    - path: "/me"
      method: GET
      handler: "users.me"
      auth: true

    - path: "/me"
      method: PATCH
      handler: "users.update"
      auth: true

    - path: "/me/connections"
      method: GET
      handler: "users.connections"
      auth: true

    - path: "/me/connections/:provider"
      method: DELETE
      handler: "users.disconnect"
      auth: true

# ═══════════════════════════════════════════════════════════════════════════════
# MIDDLEWARE
# ═══════════════════════════════════════════════════════════════════════════════

middleware:

  jwt_validation:
    name: "validateJwt"
    description: "Validates JWT access token from Authorization header"

    config:
      header: "Authorization"
      scheme: "Bearer"
      public_key: "{{JWT_PUBLIC_KEY}}"

    extracts:
      - user_id: "sub"
      - org_id: "org_id"
      - role: "role"
      - permissions: "permissions"

  rate_limiting:
    name: "rateLimit"
    description: "Rate limits requests"

    configs:
      otp_request:
        max: 5
        window_seconds: 900
        key: "ip + identifier"

      otp_verify:
        max: 10
        window_seconds: 900
        key: "ip + identifier"

# ═══════════════════════════════════════════════════════════════════════════════
# PLATFORM INTEGRATION
# ═══════════════════════════════════════════════════════════════════════════════

platform:

  description: |
    When this auth service is part of a platform, other services
    validate tokens using the public key.

  key_distribution:
    method: "environment_variable"
    env_var: "AUTH_PUBLIC_KEY"

  internal_api:
    enabled: true
    endpoints:
      - path: "/internal/validate"
        method: POST
        description: "Validate token (alternative to local validation)"
        auth: "internal_api_key"

      - path: "/internal/user/:id"
        method: GET
        description: "Get user details"
        auth: "internal_api_key"

      - path: "/internal/users/by-email/:email"
        method: GET
        description: "Get user by email"
        auth: "internal_api_key"

  service_auth:
    method: "internal_api_key"
    header: "X-Internal-Api-Key"
    env_var: "INTERNAL_API_KEY"
